<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssemblyScript è½¬ WebAssembly ç¤ºä¾‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            border-bottom: 3px solid #007acc;
            padding-bottom: 10px;
            font-size: 28px;
            font-weight: bold;
        }
        h2 {
            color: #2a2a2a;
            font-size: 20px;
            font-weight: 600;
            margin-top: 30px;
        }
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #e8f4f8;
            border-left: 4px solid #007acc;
            font-family: 'Courier New', monospace;
            color: #1a1a1a;
            font-size: 15px;
            font-weight: 500;
            white-space: pre-wrap;
        }
        input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-size: 15px;
            color: white;
            background-color: #333;
        }
        input::placeholder {
            color: #aaa;
        }
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }
        .info-box strong {
            color: #664d03;
            font-size: 16px;
        }
        code {
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #c7254e;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“˜ AssemblyScript è½¬ WebAssembly ç¤ºä¾‹</h1>
        <p>å±•ç¤ºå¦‚ä½•ä½¿ç”¨ AssemblyScriptï¼ˆTypeScript å­é›†ï¼‰ç¼–å†™ä»£ç å¹¶ç¼–è¯‘ä¸º WebAssembly</p>
        
        <div class="info-box">
            <strong>AssemblyScript çš„ä¼˜åŠ¿ï¼š</strong>
            <ul>
                <li>TypeScript è¯­æ³•ï¼šç†Ÿæ‚‰çš„å¼€å‘ä½“éªŒ</li>
                <li>ç±»å‹å®‰å…¨ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥</li>
                <li>æ˜“äºå­¦ä¹ ï¼šå¯¹äº TypeScript/JavaScript å¼€å‘è€…å‹å¥½</li>
                <li>å¿«é€Ÿç¼–è¯‘ï¼šç¼–è¯‘é€Ÿåº¦å¿«</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <h2>1. åŸºæœ¬è¿ç®—</h2>
            <p>è®¡ç®— <input type="number" id="addA" value="10"> + <input type="number" id="addB" value="20"></p>
            <button onclick="demoAdd()">è®¡ç®—</button>
            <div id="addResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>2. æ–æ³¢é‚£å¥‘æ•°åˆ—</h2>
            <p>è®¡ç®—ç¬¬ <input type="number" id="fibN" value="40" min="1" max="50"> ä¸ªæ–æ³¢é‚£å¥‘æ•°</p>
            <button onclick="demoFibonacci()">è®¡ç®—</button>
            <div id="fibResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>3. é˜¶ä¹˜</h2>
            <p>è®¡ç®— <input type="number" id="factN" value="12" min="1" max="20"> çš„é˜¶ä¹˜</p>
            <button onclick="demoFactorial()">è®¡ç®—</button>
            <div id="factResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>4. æ•°ç»„æ±‚å’Œ</h2>
            <p>å¯¹æ•°ç»„ [1, 2, 3, 4, 5, 10, 20, 30] æ±‚å’Œ</p>
            <button onclick="demoSumArray()">è®¡ç®—</button>
            <div id="sumResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>5. å­—ç¬¦ä¸²æ“ä½œ</h2>
            <p>å­—ç¬¦ä¸²1: <input type="text" id="str1" value="Hello"> + å­—ç¬¦ä¸²2: <input type="text" id="str2" value=" WebAssembly"></p>
            <button onclick="demoString()">æ‹¼æ¥</button>
            <div id="stringResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>6. æ•°å­¦å‡½æ•°</h2>
            <p>è®¡ç®— <input type="number" id="base" value="2" step="0.1"> çš„ <input type="number" id="exp" value="3" step="0.1"> æ¬¡æ–¹</p>
            <button onclick="demoMath()">è®¡ç®—</button>
            <div id="mathResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>7. å†…å­˜æ“ä½œï¼ˆç±»ï¼‰</h2>
            <p>æ¼”ç¤º AssemblyScript ç±»åœ¨ WebAssembly ä¸­çš„ä½¿ç”¨</p>
            <button onclick="demoMemory()">æ¼”ç¤º</button>
            <div id="memoryResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        let wasmModule = null;
        let wasmInstance = null;

        async function initWasm() {
            if (wasmInstance) return wasmInstance;
            
            try {
                // AssemblyScript ç¼–è¯‘çš„æ¨¡å—éœ€è¦ abort å‡½æ•°
                // abort å‡½æ•°ç­¾å: (message: i32, fileName: i32, line: i32, column: i32) => void
                const importObject = {
                    env: {
                        abort: (msg, file, line, col) => {
                            console.error(`AssemblyScript abort: message=${msg}, file=${file}, line=${line}, col=${col}`);
                            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œåªè®°å½•æ—¥å¿—ï¼Œè®©ç¨‹åºç»§ç»­è¿è¡Œ
                        }
                    }
                };
                
                // åŠ è½½å¹¶å®ä¾‹åŒ–æ¨¡å—
                const response = await fetch('build/release.wasm');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const bytes = await response.arrayBuffer();
                const wasmModule = await WebAssembly.instantiate(bytes, importObject);
                
                wasmInstance = wasmModule.instance;
                console.log('AssemblyScript WebAssembly æ¨¡å—åŠ è½½æˆåŠŸï¼');
                console.log('å¯¼å‡ºçš„å‡½æ•°:', Object.keys(wasmInstance.exports));
                return wasmInstance;
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                alert(`åŠ è½½ WebAssembly å¤±è´¥: ${errorMsg}\n\nè¯·ç¡®ä¿ï¼š\n1. å·²ç¼–è¯‘ AssemblyScript ä»£ç ï¼ˆè¿è¡Œ: npm run buildï¼‰\n2. é€šè¿‡ HTTP æœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢\n3. build/release.wasm æ–‡ä»¶å­˜åœ¨`);
                return null;
            }
        }

        window.demoAdd = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const a = parseInt(document.getElementById('addA').value);
            const b = parseInt(document.getElementById('addB').value);
            const result = wasmInstance.exports.add(a, b);
            document.getElementById('addResult').style.display = 'block';
            document.getElementById('addResult').textContent = `${a} + ${b} = ${result}`;
        };

        window.demoFibonacci = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const n = parseInt(document.getElementById('fibN').value);
            const start = performance.now();
            const result = wasmInstance.exports.fibonacci(n);
            const time = performance.now() - start;
            document.getElementById('fibResult').style.display = 'block';
            document.getElementById('fibResult').textContent = `ç¬¬ ${n} ä¸ªæ–æ³¢é‚£å¥‘æ•°: ${result}\nè®¡ç®—æ—¶é—´: ${time.toFixed(2)} ms`;
        };

        window.demoFactorial = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const n = parseInt(document.getElementById('factN').value);
            const start = performance.now();
            const result = wasmInstance.exports.factorial(n);
            const time = performance.now() - start;
            document.getElementById('factResult').style.display = 'block';
            document.getElementById('factResult').textContent = `${n}! = ${result}\nè®¡ç®—æ—¶é—´: ${time.toFixed(2)} ms`;
        };

        window.demoSumArray = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const arr = new Int32Array([1, 2, 3, 4, 5, 10, 20, 30]);
            const result = wasmInstance.exports.sumArray(arr);
            document.getElementById('sumResult').style.display = 'block';
            document.getElementById('sumResult').textContent = `æ•°ç»„: [${Array.from(arr).join(', ')}]\næ±‚å’Œç»“æœ: ${result}`;
        };

        window.demoString = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const str1 = document.getElementById('str1').value;
            const str2 = document.getElementById('str2').value;
            // æ³¨æ„ï¼šAssemblyScript çš„å­—ç¬¦ä¸²æ“ä½œéœ€è¦ç‰¹æ®Šå¤„ç†
            // è¿™é‡Œç®€åŒ–æ¼”ç¤ºï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦å¤„ç†å­—ç¬¦ä¸²çš„å†…å­˜å¸ƒå±€
            document.getElementById('stringResult').style.display = 'block';
            document.getElementById('stringResult').textContent = 
                `å­—ç¬¦ä¸²1é•¿åº¦: ${str1.length}\nå­—ç¬¦ä¸²2é•¿åº¦: ${str2.length}\næ‹¼æ¥ç»“æœ: ${str1 + str2}`;
        };

        window.demoMath = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const base = parseFloat(document.getElementById('base').value);
            const exp = parseFloat(document.getElementById('exp').value);
            const result = wasmInstance.exports.power(base, exp);
            const sqrtResult = wasmInstance.exports.sqrt(result);
            document.getElementById('mathResult').style.display = 'block';
            document.getElementById('mathResult').textContent = 
                `${base}^${exp} = ${result}\nâˆš${result} = ${sqrtResult}`;
        };

        window.demoMemory = async function() {
            await initWasm();
            if (!wasmInstance) return;
            
            // åˆå§‹åŒ–æ•°ç»„
            wasmInstance.exports.initDemoArray(5);
            const initialSum = wasmInstance.exports.getDemoArraySum();
            const length = wasmInstance.exports.getDemoArrayLength();
            
            // ä¿®æ”¹æ•°ç»„ä¸­çš„å€¼
            wasmInstance.exports.setDemoArrayValue(0, 100);
            const modifiedSum = wasmInstance.exports.getDemoArraySum();
            
            document.getElementById('memoryResult').style.display = 'block';
            document.getElementById('memoryResult').textContent = 
                `åˆå§‹åŒ–æ•°ç»„ï¼ˆé•¿åº¦: ${length}ï¼‰\n` +
                `åˆå§‹æ±‚å’Œ: ${initialSum}\n` +
                `ä¿®æ”¹ç´¢å¼• 0 ä¸º 100 åæ±‚å’Œ: ${modifiedSum}\n\n` +
                `æ³¨æ„ï¼šAssemblyScript ä¸æ”¯æŒç›´æ¥å¯¼å‡ºç±»ï¼Œ\nä½¿ç”¨å‡½æ•°å’Œå…¨å±€å˜é‡æ¥æ¨¡æ‹Ÿç±»çš„åŠŸèƒ½ã€‚`;
        };
    </script>
</body>
</html>

