<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Builtins ç¤ºä¾‹ - WebAssembly</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            border-bottom: 3px solid #007acc;
            padding-bottom: 10px;
            font-size: 28px;
            font-weight: bold;
        }
        h2 {
            color: #2a2a2a;
            font-size: 20px;
            font-weight: 600;
            margin-top: 30px;
        }
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #e8f4f8;
            border-left: 4px solid #007acc;
            font-family: 'Courier New', monospace;
            color: #1a1a1a;
            font-size: 15px;
            font-weight: 500;
            white-space: pre-wrap;
        }
        input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-size: 15px;
            color: #1a1a1a;
        }
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #007acc;
            padding: 15px;
            margin: 15px 0;
            color: #1a1a1a;
        }
        .info-box strong {
            color: #007acc;
            font-size: 16px;
        }
        .info-box ul {
            color: #333;
            font-size: 15px;
            margin: 10px 0;
            padding-left: 20px;
        }
        .info-box li {
            margin: 5px 0;
        }
        code {
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #c7254e;
            font-size: 14px;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .console-line {
            margin: 3px 0;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— JavaScript Builtins ç¤ºä¾‹</h1>
        <p>å±•ç¤ºå¦‚ä½•åœ¨ WebAssembly ä¸­ä½¿ç”¨ JavaScript å†…ç½®å‡½æ•°</p>
        
        <div class="info-box">
            <strong>ä»€ä¹ˆæ˜¯ JavaScript Builtinsï¼Ÿ</strong>
            <ul>
                <li>å…è®¸ WebAssembly ç›´æ¥è°ƒç”¨ JavaScript å†…ç½®åŠŸèƒ½</li>
                <li>é€šè¿‡ <code>import</code> è¯­å¥å¯¼å…¥ JavaScript å‡½æ•°</li>
                <li>è¡¥å…… WebAssembly ç¼ºå¤±çš„é«˜çº§åŠŸèƒ½ï¼ˆå¦‚ä¸‰è§’å‡½æ•°ã€å­—ç¬¦ä¸²æ“ä½œï¼‰</li>
                <li>ç®€åŒ– WebAssembly ä¸ JavaScript çš„é›†æˆ</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <h2>1. ä¸‰è§’å‡½æ•°</h2>
            <p>è®¡ç®— sin(<input type="number" id="sinX" value="1.57" step="0.01">) â‰ˆ sin(Ï€/2)</p>
            <button onclick="demoSin()">è®¡ç®— sin</button>
            <button onclick="demoCos()">è®¡ç®— cos</button>
            <button onclick="demoTan()">è®¡ç®— tan</button>
            <div id="trigResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>2. å¯¹æ•°å‡½æ•°</h2>
            <p>è®¡ç®— ln(<input type="number" id="lnX" value="2.718" step="0.1">) å’Œ log10(<input type="number" id="log10X" value="100" step="1">)</p>
            <button onclick="demoLn()">è®¡ç®— ln</button>
            <button onclick="demoLog10()">è®¡ç®— log10</button>
            <div id="logResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>3. å¹‚è¿ç®—</h2>
            <p>è®¡ç®— <input type="number" id="base" value="2" step="0.1"> çš„ <input type="number" id="exp" value="3" step="0.1"> æ¬¡æ–¹</p>
            <button onclick="demoPower()">è®¡ç®—å¹‚</button>
            <button onclick="demoExp()">è®¡ç®— e^x</button>
            <div id="powerResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>4. æ•°å­¦æ’ç­‰å¼éªŒè¯</h2>
            <p>éªŒè¯ sinÂ²(x) + cosÂ²(x) = 1ï¼Œx = <input type="number" id="identityX" value="1.5" step="0.1"></p>
            <button onclick="demoIdentity()">éªŒè¯æ’ç­‰å¼</button>
            <div id="identityResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>5. ç»å¯¹å€¼</h2>
            <p>è®¡ç®— |<input type="number" id="absX" value="-3.14" step="0.1">|</p>
            <button onclick="demoAbs()">è®¡ç®—ç»å¯¹å€¼</button>
            <div id="absResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>6. æ§åˆ¶å°è¾“å‡º</h2>
            <p>æ¼”ç¤ºä» WebAssembly è°ƒç”¨ JavaScript console.log</p>
            <button onclick="demoConsole()">è¾“å‡ºåˆ°æ§åˆ¶å°</button>
            <div class="console-output" id="consoleOutput">
                <div class="console-line">æ§åˆ¶å°è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
        </div>
    </div>

    <script>
        let wasmInstance = null;
        let wasmMemory = null;

        // æ§åˆ¶å°æ—¥å¿—å‡½æ•°ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        function consoleLogString(offset, length) {
            const bytes = new Uint8Array(wasmMemory.buffer, offset, length);
            const string = new TextDecoder().decode(bytes);
            const consoleOutput = document.getElementById('consoleOutput');
            const line = document.createElement('div');
            line.className = 'console-line';
            line.textContent = string;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(string); // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
        }

        // åˆå§‹åŒ– WebAssembly
        async function initWasm() {
            if (wasmInstance) return wasmInstance;
            
            try {
                // åˆ›å»ºå†…å­˜
                wasmMemory = new WebAssembly.Memory({ initial: 1 });
                
                // åˆ›å»ºå¯¼å…¥å¯¹è±¡ï¼ŒåŒ…å« JavaScript Math å‡½æ•°
                const importObject = {
                    js: {
                        Math_sin: (x) => Math.sin(x),
                        Math_cos: (x) => Math.cos(x),
                        Math_tan: (x) => Math.tan(x),
                        Math_log: (x) => Math.log(x),
                        Math_log10: (x) => Math.log10(x),
                        Math_pow: (base, exp) => Math.pow(base, exp),
                        Math_abs: (x) => Math.abs(x)
                    },
                    js: {
                        mem: wasmMemory
                    },
                    console: {
                        log: consoleLogString
                    }
                };
                
                // ä¿®å¤ï¼šåˆå¹¶ js å¯¹è±¡
                const fixedImportObject = {
                    js: {
                        Math_sin: (x) => Math.sin(x),
                        Math_cos: (x) => Math.cos(x),
                        Math_tan: (x) => Math.tan(x),
                        Math_log: (x) => Math.log(x),
                        Math_log10: (x) => Math.log10(x),
                        Math_pow: (base, exp) => Math.pow(base, exp),
                        Math_abs: (x) => Math.abs(x),
                        mem: wasmMemory
                    },
                    console: {
                        log: consoleLogString
                    }
                };
                
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('builtins.wasm'),
                    fixedImportObject
                );
                
                wasmInstance = wasmModule.instance;
                console.log('JavaScript Builtins æ¨¡å—åŠ è½½æˆåŠŸï¼');
                console.log('å¯¼å‡ºçš„å‡½æ•°:', Object.keys(wasmInstance.exports));
                return wasmInstance;
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                alert(`åŠ è½½ WebAssembly å¤±è´¥: ${error.message}\n\nè¯·ç¡®ä¿ï¼š\n1. å·²ç¼–è¯‘ builtins.watï¼ˆè¿è¡Œ: wat2wasm builtins.wat -o builtins.wasmï¼‰\n2. é€šè¿‡ HTTP æœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢`);
                return null;
            }
        }

        window.demoSin = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('sinX').value);
            const result = wasmInstance.exports.sin(x);
            document.getElementById('trigResult').style.display = 'block';
            document.getElementById('trigResult').textContent = `sin(${x}) = ${result}`;
        };

        window.demoCos = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('sinX').value);
            const result = wasmInstance.exports.cos(x);
            document.getElementById('trigResult').style.display = 'block';
            document.getElementById('trigResult').textContent = `cos(${x}) = ${result}`;
        };

        window.demoTan = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('sinX').value);
            const result = wasmInstance.exports.tan(x);
            document.getElementById('trigResult').style.display = 'block';
            document.getElementById('trigResult').textContent = `tan(${x}) = ${result}`;
        };

        window.demoLn = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('lnX').value);
            const result = wasmInstance.exports.ln(x);
            document.getElementById('logResult').style.display = 'block';
            document.getElementById('logResult').textContent = `ln(${x}) = ${result}`;
        };

        window.demoLog10 = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('log10X').value);
            const result = wasmInstance.exports.log10(x);
            document.getElementById('logResult').style.display = 'block';
            document.getElementById('logResult').textContent = `log10(${x}) = ${result}`;
        };

        window.demoPower = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const base = parseFloat(document.getElementById('base').value);
            const exp = parseFloat(document.getElementById('exp').value);
            const result = wasmInstance.exports.power(base, exp);
            document.getElementById('powerResult').style.display = 'block';
            document.getElementById('powerResult').textContent = `${base}^${exp} = ${result}`;
        };

        window.demoExp = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('base').value);
            const result = wasmInstance.exports.exp(x);
            document.getElementById('powerResult').style.display = 'block';
            document.getElementById('powerResult').textContent = `e^${x} = ${result}`;
        };

        window.demoIdentity = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('identityX').value);
            const result = wasmInstance.exports.sinCosIdentity(x);
            document.getElementById('identityResult').style.display = 'block';
            document.getElementById('identityResult').textContent = 
                `sinÂ²(${x}) + cosÂ²(${x}) = ${result}\n` +
                `ç†è®ºå€¼: 1.0\n` +
                `è¯¯å·®: ${Math.abs(result - 1.0).toExponential(2)}`;
        };

        window.demoAbs = async function() {
            await initWasm();
            if (!wasmInstance) return;
            const x = parseFloat(document.getElementById('absX').value);
            const result = wasmInstance.exports.abs(x);
            document.getElementById('absResult').style.display = 'block';
            document.getElementById('absResult').textContent = `|${x}| = ${result}`;
        };

        window.demoConsole = async function() {
            await initWasm();
            if (!wasmInstance) return;
            wasmInstance.exports.sayHello();
        };
    </script>
</body>
</html>

