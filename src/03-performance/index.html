<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹ - WebAssembly</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            border-bottom: 3px solid #007acc;
            padding-bottom: 10px;
            font-size: 28px;
            font-weight: bold;
        }
        h2 {
            color: #2a2a2a;
            font-size: 20px;
            font-weight: 600;
            margin-top: 0;
        }
        p {
            color: #333;
            font-size: 16px;
            margin: 10px 0;
        }
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .demo-section p {
            color: #444;
            font-size: 15px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #e8f4f8;
            border-left: 4px solid #007acc;
            font-family: 'Courier New', monospace;
            color: #1a1a1a;
            font-size: 15px;
        }
        .performance-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .performance-box {
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .performance-box h3 {
            color: #1a1a1a;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 10px 0;
        }
        .js-performance {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #333;
        }
        .wasm-performance {
            background: #d1ecf1;
            border: 2px solid #007acc;
            color: #1a1a1a;
        }
        .time {
            font-size: 26px;
            font-weight: bold;
            margin: 10px 0;
            color: #1a1a1a;
        }
        .performance-box div {
            color: #444;
            font-size: 14px;
        }
        .speedup {
            font-size: 20px;
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 100px;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 0;
            color: #856404;
            font-size: 15px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹</h1>
        <p>å¯¹æ¯” JavaScript å’Œ WebAssembly åœ¨è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸­çš„æ€§èƒ½å·®å¼‚</p>
        
        <div class="demo-section">
            <h2>æµ‹è¯• 1: æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼ˆé€’å½’ï¼‰</h2>
            <div class="warning">
                âš ï¸ æ³¨æ„ï¼šé€’å½’ç‰ˆæœ¬è®¡ç®—è¾ƒå¤§æ•°å­—ä¼šå¾ˆæ…¢ï¼Œå»ºè®®æµ‹è¯• n â‰¤ 40
            </div>
            <p>è®¡ç®—ç¬¬ <input type="number" id="fibN" value="35" min="1" max="45"> ä¸ªæ–æ³¢é‚£å¥‘æ•°</p>
            <button onclick="compareFibonacci()">å¼€å§‹æ€§èƒ½å¯¹æ¯”</button>
            <div id="fibResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>æµ‹è¯• 2: æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼ˆè¿­ä»£ï¼‰</h2>
            <div class="warning">
                âš ï¸ æ³¨æ„ï¼šWebAssembly ä½¿ç”¨ i32ï¼ˆæœ€å¤§å€¼çº¦21äº¿ï¼‰ï¼Œå½“ n > 46 æ—¶ç»“æœä¼šæº¢å‡ºã€‚å»ºè®®æµ‹è¯• n â‰¤ 46ã€‚
            </div>
            <p>è®¡ç®—ç¬¬ <input type="number" id="fibIterN" value="40" min="1" max="50"> ä¸ªæ–æ³¢é‚£å¥‘æ•°ï¼ˆè¿­ä»£ç‰ˆæœ¬ï¼‰</p>
            <button onclick="compareFibonacciIterative()">å¼€å§‹æ€§èƒ½å¯¹æ¯”</button>
            <div id="fibIterResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>æµ‹è¯• 3: é˜¶ä¹˜è®¡ç®—</h2>
            <div class="warning">
                âš ï¸ æ³¨æ„ï¼šWebAssembly ä½¿ç”¨ i32ï¼Œåªèƒ½å®‰å…¨è®¡ç®—åˆ° 12!ã€‚JavaScript å¯ä»¥åˆ° 170!ã€‚å»ºè®®æµ‹è¯• n â‰¤ 12 è¿›è¡Œå…¬å¹³å¯¹æ¯”ã€‚
            </div>
            <p>è®¡ç®— <input type="number" id="factN" value="12" min="1" max="20"> çš„é˜¶ä¹˜</p>
            <button onclick="compareFactorial()">å¼€å§‹æ€§èƒ½å¯¹æ¯”</button>
            <div id="factResult" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>æµ‹è¯• 4: æ•°ç»„æ±‚å’Œ</h2>
            <div class="warning">
                âš ï¸ æ³¨æ„ï¼šWebAssembly ä½¿ç”¨ i32ï¼ˆæœ€å¤§å€¼çº¦21äº¿ï¼‰ã€‚æ•°ç»„å…ƒç´ å€¼è¾ƒå¤§æˆ–æ•°é‡å¾ˆå¤šæ—¶å¯èƒ½æº¢å‡ºã€‚å»ºè®®æ•°ç»„å…ƒç´ å€¼ â‰¤ 1000ã€‚
            </div>
            <p>å¯¹åŒ…å« <input type="number" id="arraySize" value="100000" min="1000" step="10000"> ä¸ªå…ƒç´ çš„æ•°ç»„æ±‚å’Œï¼ˆå…ƒç´ å€¼ä¸º 1 åˆ° nï¼‰</p>
            <button onclick="compareArraySum()">å¼€å§‹æ€§èƒ½å¯¹æ¯”</button>
            <div id="arrayResult" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        let wasmInstance = null;
        let wasmMemory = null;

        // JavaScript å®ç°ï¼šæ–æ³¢é‚£å¥‘ï¼ˆé€’å½’ï¼‰
        function jsFibRecursive(n) {
            if (n <= 1) return n;
            return jsFibRecursive(n - 1) + jsFibRecursive(n - 2);
        }

        // JavaScript å®ç°ï¼šæ–æ³¢é‚£å¥‘ï¼ˆè¿­ä»£ï¼‰
        function jsFibIterative(n) {
            if (n <= 1) return n;
            let a = 0, b = 1;
            for (let i = 2; i <= n; i++) {
                let temp = a + b;
                a = b;
                b = temp;
            }
            return b;
        }

        // JavaScript å®ç°ï¼šé˜¶ä¹˜ï¼ˆå¸¦æº¢å‡ºæ£€æµ‹ï¼‰
        function jsFactorial(n) {
            // JavaScript Number ç±»å‹çš„å®‰å…¨æ•´æ•°èŒƒå›´
            // è¶…è¿‡è¿™ä¸ªèŒƒå›´ä¼šå¤±å»ç²¾åº¦æˆ–å˜æˆ Infinity
            if (n > 170) {
                return Infinity; // 170! å·²ç»è¶…å‡ºå®‰å…¨èŒƒå›´
            }
            let result = 1;
            for (let i = 1; i <= n; i++) {
                result *= i;
                // æ£€æµ‹æº¢å‡º
                if (!isFinite(result)) {
                    return Infinity;
                }
            }
            return result;
        }

        // JavaScript å®ç°ï¼šæ•°ç»„æ±‚å’Œ
        function jsSumArray(arr) {
            let sum = 0;
            for (let i = 0; i < arr.length; i++) {
                sum += arr[i];
            }
            return sum;
        }

        // æ€§èƒ½æµ‹è¯•è¾…åŠ©å‡½æ•°
        function measureTime(fn) {
            const start = performance.now();
            const result = fn();
            const end = performance.now();
            return {
                result: result,
                time: end - start
            };
        }

        // åˆå§‹åŒ– WebAssembly
        async function initWasm() {
            if (wasmInstance) return wasmInstance;
            
            try {
                // åˆ›å»ºå†…å­˜ï¼ˆç”¨äº sum_array å‡½æ•°ï¼‰
                if (!wasmMemory) {
                    wasmMemory = new WebAssembly.Memory({ initial: 1 });
                }
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('fibonacci.wasm'),
                    { js: { mem: wasmMemory } }
                );
                wasmInstance = wasmModule.instance;
                return wasmInstance;
            } catch (error) {
                console.error('åŠ è½½ WebAssembly å¤±è´¥:', error);
                alert('åŠ è½½ WebAssembly å¤±è´¥ï¼Œè¯·ç¡®ä¿é€šè¿‡ HTTP æœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢');
                return null;
            }
        }

        // å¯¹æ¯”æ–æ³¢é‚£å¥‘ï¼ˆé€’å½’ï¼‰
        async function compareFibonacci() {
            const n = parseInt(document.getElementById('fibN').value);
            if (n > 45) {
                alert('é€’å½’ç‰ˆæœ¬è®¡ç®— n > 45 ä¼šéå¸¸æ…¢ï¼Œå»ºè®®ä½¿ç”¨è¾ƒå°çš„å€¼');
                return;
            }
            
            await initWasm();
            if (!wasmInstance) return;
            
            const resultDiv = document.getElementById('fibResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>è®¡ç®—ä¸­...</p>';
            
            // JavaScript ç‰ˆæœ¬
            const jsResult = measureTime(() => jsFibRecursive(n));
            
            // WebAssembly ç‰ˆæœ¬
            const wasmResult = measureTime(() => wasmInstance.exports.fib_recursive(n));
            
            const speedup = (jsResult.time / wasmResult.time).toFixed(2);
            
            resultDiv.innerHTML = `
                <div class="performance-comparison">
                    <div class="performance-box js-performance">
                        <h3>JavaScript</h3>
                        <div class="time">${jsResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${jsResult.result}</div>
                    </div>
                    <div class="performance-box wasm-performance">
                        <h3>WebAssembly</h3>
                        <div class="time">${wasmResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${wasmResult.result}</div>
                    </div>
                </div>
                <div class="speedup">ğŸš€ WebAssembly å¿« ${speedup}x</div>
            `;
        }

        // å¯¹æ¯”æ–æ³¢é‚£å¥‘ï¼ˆè¿­ä»£ï¼‰
        async function compareFibonacciIterative() {
            const n = parseInt(document.getElementById('fibIterN').value);
            
            // i32 æœ€å¤§å€¼çº¦ 2,147,483,647
            // ç¬¬ 46 ä¸ªæ–æ³¢é‚£å¥‘æ•°çº¦ä¸º 1,836,311,903ï¼Œä»åœ¨èŒƒå›´å†…
            // ç¬¬ 47 ä¸ªçº¦ä¸º 2,971,215,073ï¼Œè¶…å‡ºèŒƒå›´
            if (n > 46) {
                alert('WebAssembly ä½¿ç”¨ i32 ç±»å‹ï¼Œå½“ n > 46 æ—¶ç»“æœä¼šæº¢å‡ºã€‚å»ºè®®ä½¿ç”¨ n â‰¤ 46 è¿›è¡Œæµ‹è¯•ã€‚');
                return;
            }
            
            await initWasm();
            if (!wasmInstance) return;
            
            const resultDiv = document.getElementById('fibIterResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>è®¡ç®—ä¸­...</p>';
            
            // JavaScript ç‰ˆæœ¬
            const jsResult = measureTime(() => jsFibIterative(n));
            
            // WebAssembly ç‰ˆæœ¬
            const wasmResult = measureTime(() => wasmInstance.exports.fib_iterative(n));
            
            // æ£€æŸ¥æº¢å‡ºï¼ˆi32 æº¢å‡ºåä¼šå˜æˆè´Ÿæ•°æˆ–å¾ˆå°çš„æ­£æ•°ï¼‰
            const jsValue = jsResult.result;
            const wasmValue = wasmResult.result;
            const expectedValue = jsValue; // JavaScript çš„ç»“æœä½œä¸ºå‚è€ƒ
            
            let jsResultDisplay = jsValue;
            let wasmResultDisplay = wasmValue;
            let speedup = 'N/A';
            let overflowWarning = '';
            
            // æ£€æŸ¥ WebAssembly æ˜¯å¦æº¢å‡ºï¼ˆç»“æœä¸ JavaScript ä¸ä¸€è‡´ä¸”ä¸åˆç†ï¼‰
            if (wasmValue !== expectedValue && (wasmValue < 0 || wasmValue < expectedValue / 2)) {
                wasmResultDisplay = `${wasmValue} (æº¢å‡º)`;
                overflowWarning = '<div style="color: #dc3545; font-size: 12px; margin-top: 5px;">âš ï¸ WebAssembly ç»“æœæº¢å‡º</div>';
            } else {
                speedup = (jsResult.time / wasmResult.time).toFixed(2);
            }
            
            resultDiv.innerHTML = `
                <div class="performance-comparison">
                    <div class="performance-box js-performance">
                        <h3>JavaScript</h3>
                        <div class="time">${jsResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${jsResultDisplay}</div>
                    </div>
                    <div class="performance-box wasm-performance">
                        <h3>WebAssembly</h3>
                        <div class="time">${wasmResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${wasmResultDisplay}</div>
                        ${overflowWarning}
                    </div>
                </div>
                ${speedup !== 'N/A' ? `<div class="speedup">ğŸš€ WebAssembly å¿« ${speedup}x</div>` : '<div style="color: #856404; margin-top: 10px;">âš ï¸ æ— æ³•æ¯”è¾ƒæ€§èƒ½ï¼ˆå­˜åœ¨æº¢å‡ºï¼‰</div>'}
            `;
        }

        // å¯¹æ¯”é˜¶ä¹˜
        async function compareFactorial() {
            const n = parseInt(document.getElementById('factN').value);
            
            // i32 æœ€å¤§å€¼ï¼š2,147,483,647
            // 12! = 479,001,600 (å®‰å…¨)
            // 13! = 6,227,020,800 (æº¢å‡º)
            if (n > 12) {
                alert('WebAssembly ä½¿ç”¨ i32 ç±»å‹ï¼Œåªèƒ½å®‰å…¨è®¡ç®—åˆ° 12!ã€‚13! ä¼šæº¢å‡ºã€‚å»ºè®®ä½¿ç”¨ n â‰¤ 12 è¿›è¡Œæµ‹è¯•ã€‚');
                return;
            }
            
            await initWasm();
            if (!wasmInstance) return;
            
            const resultDiv = document.getElementById('factResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>è®¡ç®—ä¸­...</p>';
            
            // JavaScript ç‰ˆæœ¬
            const jsResult = measureTime(() => jsFactorial(n));
            
            // WebAssembly ç‰ˆæœ¬
            const wasmResult = measureTime(() => wasmInstance.exports.factorial(n));
            
            // å¤„ç†æº¢å‡ºæƒ…å†µ
            const jsValue = jsResult.result;
            const wasmValue = wasmResult.result;
            let jsResultDisplay = jsValue;
            let wasmResultDisplay = wasmValue;
            let speedup = 'N/A';
            let overflowWarning = '';
            
            // æ£€æŸ¥ JavaScript æº¢å‡º
            if (!isFinite(jsValue)) {
                jsResultDisplay = 'Infinity (æº¢å‡º)';
            }
            
            // æ£€æŸ¥ WebAssembly æº¢å‡ºï¼ˆi32 æº¢å‡ºåä¼šå›ç»•ï¼Œç»“æœä¼šä¸ JavaScript ä¸ä¸€è‡´ï¼‰
            // 12! = 479,001,600ï¼Œå¦‚æœ WebAssembly ç»“æœä¸åŒï¼Œå¯èƒ½æº¢å‡º
            const expectedValues = {
                1: 1, 2: 2, 3: 6, 4: 24, 5: 120, 6: 720, 7: 5040, 8: 40320,
                9: 362880, 10: 3628800, 11: 39916800, 12: 479001600
            };
            
            if (expectedValues[n] && wasmValue !== expectedValues[n]) {
                wasmResultDisplay = `${wasmValue} (æº¢å‡º)`;
                overflowWarning = '<div style="color: #dc3545; font-size: 12px; margin-top: 5px;">âš ï¸ WebAssembly ç»“æœæº¢å‡º</div>';
            } else if (isFinite(jsValue) && wasmValue === jsValue) {
                speedup = (jsResult.time / wasmResult.time).toFixed(2);
            }
            
            resultDiv.innerHTML = `
                <div class="performance-comparison">
                    <div class="performance-box js-performance">
                        <h3>JavaScript</h3>
                        <div class="time">${jsResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${jsResultDisplay}</div>
                        ${!isFinite(jsValue) ? '<div style="color: #dc3545; font-size: 12px; margin-top: 5px;">âš ï¸ æ•°å€¼æº¢å‡º</div>' : ''}
                    </div>
                    <div class="performance-box wasm-performance">
                        <h3>WebAssembly</h3>
                        <div class="time">${wasmResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${wasmResultDisplay}</div>
                        ${overflowWarning}
                    </div>
                </div>
                ${speedup !== 'N/A' ? `<div class="speedup">ğŸš€ WebAssembly å¿« ${speedup}x</div>` : '<div style="color: #856404; margin-top: 10px;">âš ï¸ æ— æ³•æ¯”è¾ƒæ€§èƒ½ï¼ˆå­˜åœ¨æº¢å‡ºï¼‰</div>'}
            `;
        }

        // å¯¹æ¯”æ•°ç»„æ±‚å’Œ
        async function compareArraySum() {
            const size = parseInt(document.getElementById('arraySize').value);
            
            // i32 æœ€å¤§å€¼ï¼š2,147,483,647
            // æ•°ç»„å…ƒç´ å€¼ä¸º 1 åˆ° sizeï¼Œæ±‚å’Œ = size * (size + 1) / 2
            // å½“ size * (size + 1) / 2 > 2,147,483,647 æ—¶ä¼šæº¢å‡º
            // å¤§çº¦ size > 65535 æ—¶ä¼šæº¢å‡º
            const maxSafeSize = 65535;
            if (size > maxSafeSize) {
                alert(`æ•°ç»„æ±‚å’Œç»“æœå¯èƒ½è¶…å‡º i32 èŒƒå›´ï¼ˆæœ€å¤§å€¼çº¦21äº¿ï¼‰ã€‚å»ºè®®ä½¿ç”¨ size â‰¤ ${maxSafeSize} è¿›è¡Œæµ‹è¯•ã€‚`);
                return;
            }
            
            await initWasm();
            if (!wasmInstance || !wasmMemory) return;
            
            const resultDiv = document.getElementById('arrayResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>å‡†å¤‡æ•°æ®å¹¶è®¡ç®—ä¸­...</p>';
            
            // å‡†å¤‡æ•°ç»„æ•°æ®ï¼ˆå…ƒç´ å€¼ä¸º 1 åˆ° sizeï¼‰
            const array = new Array(size).fill(0).map((_, i) => i + 1);
            
            // è®¡ç®—æœŸæœ›ç»“æœï¼ˆç”¨äºéªŒè¯ï¼‰
            const expectedSum = size * (size + 1) / 2;
            
            // å°†æ•°ç»„å†™å…¥ WebAssembly å†…å­˜
            const ptr = 0;
            const view = new Int32Array(wasmMemory.buffer);
            for (let i = 0; i < size; i++) {
                view[i] = array[i];
            }
            
            // JavaScript ç‰ˆæœ¬
            const jsResult = measureTime(() => jsSumArray(array));
            
            // WebAssembly ç‰ˆæœ¬
            const wasmResult = measureTime(() => 
                wasmInstance.exports.sum_array(ptr, size)
            );
            
            // æ£€æŸ¥æº¢å‡º
            const jsValue = jsResult.result;
            const wasmValue = wasmResult.result;
            let jsResultDisplay = jsValue;
            let wasmResultDisplay = wasmValue;
            let speedup = 'N/A';
            let overflowWarning = '';
            
            // æ£€æŸ¥ WebAssembly æ˜¯å¦æº¢å‡º
            if (wasmValue !== expectedSum && (wasmValue < 0 || wasmValue < expectedSum / 2)) {
                wasmResultDisplay = `${wasmValue} (æº¢å‡ºï¼ŒæœŸæœ›: ${expectedSum})`;
                overflowWarning = '<div style="color: #dc3545; font-size: 12px; margin-top: 5px;">âš ï¸ WebAssembly ç»“æœæº¢å‡º</div>';
            } else if (jsValue === expectedSum && wasmValue === expectedSum) {
                speedup = (jsResult.time / wasmResult.time).toFixed(2);
            }
            
            resultDiv.innerHTML = `
                <div class="performance-comparison">
                    <div class="performance-box js-performance">
                        <h3>JavaScript</h3>
                        <div class="time">${jsResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${jsResultDisplay}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">æœŸæœ›: ${expectedSum}</div>
                    </div>
                    <div class="performance-box wasm-performance">
                        <h3>WebAssembly</h3>
                        <div class="time">${wasmResult.time.toFixed(2)} ms</div>
                        <div>ç»“æœ: ${wasmResultDisplay}</div>
                        ${overflowWarning}
                    </div>
                </div>
                ${speedup !== 'N/A' ? `<div class="speedup">ğŸš€ WebAssembly å¿« ${speedup}x</div>` : '<div style="color: #856404; margin-top: 10px;">âš ï¸ æ— æ³•æ¯”è¾ƒæ€§èƒ½ï¼ˆå­˜åœ¨æº¢å‡ºï¼‰</div>'}
            `;
        }
    </script>
</body>
</html>

