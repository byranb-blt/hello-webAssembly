<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASI æ¼”ç¤º - WebAssembly System Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        h2 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
        }
        
        .info-box {
            background: #f5f7fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .info-box p {
            margin: 5px 0;
            line-height: 1.6;
            color: #555;
        }
        
        .info-box code {
            background: #e8ecf1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #d63384;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            flex: 1;
            min-width: 150px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .console .stdout {
            color: #d4d4d4;
        }
        
        .console .stderr {
            color: #f48771;
        }
        
        .console .info {
            color: #569cd6;
        }
        
        .console .error {
            color: #f48771;
        }
        
        .console .success {
            color: #4ec9b0;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .code-block code {
            color: #d4d4d4;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box p {
            margin: 5px 0;
            color: #856404;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ WASI æ¼”ç¤º</h1>
            <p class="subtitle">WebAssembly System Interface - ç³»ç»Ÿæ¥å£æ¼”ç¤º</p>
        </header>
        
        <div class="content">
            <div class="section">
                <h2>ğŸ“– ä»€ä¹ˆæ˜¯ WASIï¼Ÿ</h2>
                <div class="info-box">
                    <p><strong>WASI (WebAssembly System Interface)</strong> æ˜¯ä¸€ä¸ªç³»ç»Ÿæ¥å£æ ‡å‡†ï¼Œå…è®¸ WebAssembly ç¨‹åºä¸æ“ä½œç³»ç»Ÿäº¤äº’ã€‚</p>
                    <p>â€¢ <strong>ç»Ÿä¸€æ¥å£</strong>ï¼šæä¾›è·¨å¹³å°çš„ç³»ç»Ÿè°ƒç”¨æ¥å£</p>
                    <p>â€¢ <strong>å¯ç§»æ¤æ€§</strong>ï¼šä¸€æ¬¡ç¼–è¯‘ï¼Œå¤šå¹³å°è¿è¡Œ</p>
                    <p>â€¢ <strong>å®‰å…¨æ€§</strong>ï¼šåœ¨æ²™ç›’ç¯å¢ƒä¸­å®‰å…¨æ‰§è¡Œ</p>
                    <p>â€¢ <strong>åº”ç”¨åœºæ™¯</strong>ï¼šæœåŠ¡å™¨ã€è¾¹ç¼˜è®¡ç®—ã€å‘½ä»¤è¡Œå·¥å…·</p>
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸš€ è¿è¡Œæ–¹å¼</h2>
                <div class="info-box">
                    <p><strong>1. æµè§ˆå™¨ç¯å¢ƒ</strong>ï¼šä½¿ç”¨ WASI polyfill æ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨</p>
                    <p><strong>2. åŸç”Ÿç¯å¢ƒ</strong>ï¼šä½¿ç”¨ wasmer æˆ– wasmtime ç›´æ¥è¿è¡Œ</p>
                </div>
                
                <div class="warning-box">
                    <p><strong>âš ï¸ æ³¨æ„</strong>ï¼šåœ¨æµè§ˆå™¨ä¸­ï¼ŒWASI åŠŸèƒ½éœ€è¦é€šè¿‡ polyfill å®ç°ã€‚æœ¬ç¤ºä¾‹ä½¿ç”¨ç®€åŒ–çš„ polyfill æ¥æ¼”ç¤º WASI çš„åŸºæœ¬åŠŸèƒ½ã€‚</p>
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸ’» æ§åˆ¶å°è¾“å‡º</h2>
                <div id="status" class="status loading">æ­£åœ¨åŠ è½½ WebAssembly æ¨¡å—...</div>
                <div id="console" class="console"></div>
                
                <div class="button-group">
                    <button id="btnRun" onclick="runWasiProgram()">è¿è¡Œ WASI ç¨‹åº</button>
                    <button id="btnWriteMessage" onclick="writeCustomMessage()">å†™å…¥è‡ªå®šä¹‰æ¶ˆæ¯</button>
                    <button id="btnWriteError" onclick="writeErrorMessage()">å†™å…¥é”™è¯¯æ¶ˆæ¯</button>
                    <button id="btnClear" onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸ“ ä»£ç è¯´æ˜</h2>
                <div class="code-block">
<code>;; WASI fd_write å‡½æ•°ç­¾å
;; (func $fd_write 
;;   (param i32)  ; file_descriptor (1=stdout, 2=stderr)
;;   (param i32)  ; *iovs (io vector æ•°ç»„æŒ‡é’ˆ)
;;   (param i32)  ; iovs_len (io vector æ•°é‡)
;;   (param i32)  ; *nwritten (å†™å…¥å­—èŠ‚æ•°æŒ‡é’ˆ)
;;   (result i32) ; é”™è¯¯ç  (0=æˆåŠŸ)
;; )

;; io vector ç»“æ„ï¼ˆ8å­—èŠ‚ï¼‰ï¼š
;;   offset 0-3: iov_base (æ•°æ®æŒ‡é’ˆ)
;;   offset 4-7: iov_len  (æ•°æ®é•¿åº¦)</code>
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸ”§ åŸç”Ÿç¯å¢ƒè¿è¡Œ</h2>
                <div class="code-block">
<code># ä½¿ç”¨ wasmer è¿è¡Œ
wasmer run wasi-demo.wasm

# ä½¿ç”¨ wasmtime è¿è¡Œ
wasmtime wasi-demo.wasm

# è¾“å‡ºï¼š
# Hello from WASI!
# This is a WASI demo.
# WebAssembly System Interface</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        let wasmInstance = null;
        let memory = null;
        const consoleOutput = document.getElementById('console');
        const statusDiv = document.getElementById('status');
        
        // ç®€åŒ–çš„ WASI polyfill - fd_write å®ç°
        function createWasiPolyfill() {
            return {
                wasi_unstable: {
                    fd_write: (fd, iovs, iovs_len, nwritten_ptr) => {
                        const view = new DataView(memory.buffer);
                        let totalWritten = 0;
                        
                        for (let i = 0; i < iovs_len; i++) {
                            // è¯»å– io vector
                            const iov_base = view.getUint32(iovs + i * 8, true);
                            const iov_len = view.getUint32(iovs + i * 8 + 4, true);
                            
                            // è¯»å–å­—ç¬¦ä¸²æ•°æ®
                            const bytes = new Uint8Array(memory.buffer, iov_base, iov_len);
                            const text = new TextDecoder('utf8').decode(bytes);
                            
                            // æ ¹æ®æ–‡ä»¶æè¿°ç¬¦è¾“å‡º
                            if (fd === 1) {
                                // stdout
                                logToConsole(text, 'stdout');
                            } else if (fd === 2) {
                                // stderr
                                logToConsole(text, 'stderr');
                            }
                            
                            totalWritten += iov_len;
                        }
                        
                        // å†™å…¥å®é™…å†™å…¥çš„å­—èŠ‚æ•°
                        view.setUint32(nwritten_ptr, totalWritten, true);
                        
                        return 0; // è¿”å› 0 è¡¨ç¤ºæˆåŠŸ
                    }
                }
            };
        }
        
        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function logToConsole(message, type = 'stdout') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'stderr' ? 'stderr' : 'stdout';
            consoleOutput.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // åˆå§‹åŒ– WebAssembly
        async function initWasm() {
            try {
                statusDiv.className = 'status loading';
                statusDiv.textContent = 'æ­£åœ¨åŠ è½½ WebAssembly æ¨¡å—...';
                
                // åˆ›å»ºå†…å­˜
                memory = new WebAssembly.Memory({ initial: 1 });
                
                // åˆ›å»ºå¯¼å…¥å¯¹è±¡ï¼ˆåŒ…å« WASI polyfillï¼‰
                const importObject = {
                    wasi_unstable: createWasiPolyfill().wasi_unstable
                };
                
                // åŠ è½½å¹¶å®ä¾‹åŒ–æ¨¡å—
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('wasi-demo.wasm'),
                    importObject
                );
                
                wasmInstance = wasmModule.instance;
                memory = wasmInstance.exports.memory;
                
                // æ›´æ–°å¯¼å…¥å¯¹è±¡ä¸­çš„å†…å­˜å¼•ç”¨
                importObject.wasi_unstable = createWasiPolyfill().wasi_unstable;
                
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… WebAssembly æ¨¡å—åŠ è½½æˆåŠŸï¼';
                logToConsole('WebAssembly æ¨¡å—åŠ è½½æˆåŠŸï¼', 'success');
                
                return wasmInstance;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
                logToConsole(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                console.error('åŠ è½½ WebAssembly å¤±è´¥:', error);
                return null;
            }
        }
        
        // è¿è¡Œ WASI ç¨‹åºï¼ˆè°ƒç”¨ _startï¼‰
        async function runWasiProgram() {
            if (!wasmInstance) {
                wasmInstance = await initWasm();
                if (!wasmInstance) return;
            }
            
            try {
                logToConsole('--- è¿è¡Œ WASI ç¨‹åº (_start) ---', 'info');
                wasmInstance.exports._start();
                logToConsole('--- ç¨‹åºæ‰§è¡Œå®Œæˆ ---', 'info');
            } catch (error) {
                logToConsole(`æ‰§è¡Œé”™è¯¯: ${error.message}`, 'error');
                console.error('æ‰§è¡Œé”™è¯¯:', error);
            }
        }
        
        // å†™å…¥è‡ªå®šä¹‰æ¶ˆæ¯
        async function writeCustomMessage() {
            if (!wasmInstance) {
                wasmInstance = await initWasm();
                if (!wasmInstance) return;
            }
            
            try {
                const message = 'Custom message from JavaScript!\n';
                const encoder = new TextEncoder();
                const bytes = encoder.encode(message);
                
                // å°†æ¶ˆæ¯å†™å…¥å†…å­˜ï¼ˆåç§» 200ï¼‰
                const view = new Uint8Array(memory.buffer);
                view.set(bytes, 200);
                
                // è°ƒç”¨ writeMessage å‡½æ•°
                wasmInstance.exports.writeMessage(200, bytes.length);
            } catch (error) {
                logToConsole(`æ‰§è¡Œé”™è¯¯: ${error.message}`, 'error');
                console.error('æ‰§è¡Œé”™è¯¯:', error);
            }
        }
        
        // å†™å…¥é”™è¯¯æ¶ˆæ¯
        async function writeErrorMessage() {
            if (!wasmInstance) {
                wasmInstance = await initWasm();
                if (!wasmInstance) return;
            }
            
            try {
                const message = 'This is an error message!\n';
                const encoder = new TextEncoder();
                const bytes = encoder.encode(message);
                
                // å°†æ¶ˆæ¯å†™å…¥å†…å­˜ï¼ˆåç§» 250ï¼‰
                const view = new Uint8Array(memory.buffer);
                view.set(bytes, 250);
                
                // è°ƒç”¨ writeError å‡½æ•°ï¼ˆå†™å…¥åˆ° stderrï¼‰
                wasmInstance.exports.writeError(250, bytes.length);
            } catch (error) {
                logToConsole(`æ‰§è¡Œé”™è¯¯: ${error.message}`, 'error');
                console.error('æ‰§è¡Œé”™è¯¯:', error);
            }
        }
        
        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            consoleOutput.innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initWasm();
        });
    </script>
</body>
</html>

