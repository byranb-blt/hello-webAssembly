<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo 3: å¤æ‚æ’åºæ€§èƒ½å¯¹æ¯”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        h2 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .input-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            flex: 1;
            min-width: 150px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .result-box {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }
        
        .result-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .result-box.wasm {
            border-left-color: #4ec9b0;
        }
        
        .result-box.wasm h3 {
            color: #4ec9b0;
        }
        
        .result-box.js {
            border-left-color: #f48771;
        }
        
        .result-box.js h3 {
            color: #f48771;
        }
        
        .metric {
            margin: 10px 0;
            font-size: 14px;
        }
        
        .metric strong {
            color: #333;
            display: inline-block;
            min-width: 120px;
        }
        
        .metric-value {
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-weight: bold;
        }
        
        .comparison {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .comparison h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .speedup {
            font-size: 24px;
            font-weight: bold;
            color: #856404;
            text-align: center;
            margin: 10px 0;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #569cd6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #555;
            line-height: 1.6;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box p {
            margin: 5px 0;
            color: #856404;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¢ Demo 3: å¤æ‚æ’åºæ€§èƒ½å¯¹æ¯”</h1>
            <p class="subtitle">JavaScript vs WebAssembly - 100 ä¸‡æ•°æ®æ’åºæ€§èƒ½æµ‹è¯•</p>
        </header>
        
        <div class="content">
            <div class="section">
                <h2>ğŸ“– è¯´æ˜</h2>
                <div class="info-box">
                    <p>æœ¬æ¼”ç¤ºå¯¹æ¯” JavaScript å’Œ WebAssembly åœ¨å¤§è§„æ¨¡æ•°æ®æ’åºä¸­çš„æ€§èƒ½å·®å¼‚ã€‚</p>
                    <p>â€¢ <strong>æ’åºç®—æ³•</strong>ï¼šå¿«é€Ÿæ’åºï¼ˆQuicksortï¼‰</p>
                    <p>â€¢ <strong>æµ‹è¯•æ•°æ®</strong>ï¼šéšæœºç”Ÿæˆçš„æ•´æ•°æ•°ç»„</p>
                    <p>â€¢ <strong>æ€§èƒ½æŒ‡æ ‡</strong>ï¼šæ‰§è¡Œæ—¶é—´ã€æ’åºé€Ÿåº¦ï¼ˆå…ƒç´ /ç§’ï¼‰</p>
                </div>
                <div class="warning-box">
                    <p><strong>âš ï¸ æ³¨æ„</strong>ï¼šå¤§æ•°æ®é‡æ’åºå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚å»ºè®®ä»è¾ƒå°çš„æ•°æ®é‡å¼€å§‹æµ‹è¯•ã€‚</p>
                </div>
            </div>
            
            <div class="section">
                <h2>âš™ï¸ æµ‹è¯•é…ç½®</h2>
                <div class="controls">
                    <div class="input-group">
                        <label for="dataSize">æ•°æ®é‡</label>
                        <input type="number" id="dataSize" value="100000" min="1000" max="10000000" step="1000">
                    </div>
                    <div class="input-group">
                        <label for="algorithm">æ’åºç®—æ³•</label>
                        <select id="algorithm">
                            <option value="quicksort">å¿«é€Ÿæ’åº (Quicksort)</option>
                            <option value="bubblesort">å†’æ³¡æ’åº (Bubblesort)</option>
                        </select>
                    </div>
                </div>
                <div class="controls">
                    <button id="btnTest" onclick="runSortingTest()">å¼€å§‹æ€§èƒ½æµ‹è¯•</button>
                    <button id="btnClear" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
                </div>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
            
            <div class="section">
                <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
                <div id="results" class="results"></div>
                <div id="comparison" class="comparison" style="display: none;">
                    <h3>æ€§èƒ½å¯¹æ¯”</h3>
                    <div id="speedup" class="speedup"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let wasmInstance = null;
        let memory = null;
        
        // JavaScript å¿«é€Ÿæ’åº
        function jsQuicksort(arr) {
            if (arr.length <= 1) return arr;
            
            const pivot = arr[Math.floor(arr.length / 2)];
            const left = [];
            const middle = [];
            const right = [];
            
            for (const element of arr) {
                if (element < pivot) {
                    left.push(element);
                } else if (element > pivot) {
                    right.push(element);
                } else {
                    middle.push(element);
                }
            }
            
            return [...jsQuicksort(left), ...middle, ...jsQuicksort(right)];
        }
        
        // JavaScript åŸç”Ÿæ’åºï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
        function jsNativeSort(arr) {
            const copy = arr.slice();
            copy.sort((a, b) => a - b);
            return copy;
        }
        
        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        function generateTestData(size) {
            const data = new Int32Array(size);
            for (let i = 0; i < size; i++) {
                data[i] = Math.floor(Math.random() * 1000000);
            }
            return data;
        }
        
        // éªŒè¯æ’åºç»“æœ
        function isSorted(arr) {
            for (let i = 1; i < arr.length; i++) {
                if (arr[i] < arr[i - 1]) {
                    return false;
                }
            }
            return true;
        }
        
        // åˆå§‹åŒ– WebAssembly
        async function initWasm() {
            if (wasmInstance && memory) {
                return wasmInstance;
            }
            
            try {
                // è®¡ç®—éœ€è¦çš„å†…å­˜é¡µæ•°ï¼ˆæ¯é¡µ 64KBï¼‰
                // 1000ä¸‡æ•´æ•° = 40MBï¼Œéœ€è¦çº¦ 625 é¡µ
                const initialPages = 700; // é¢„ç•™ä¸€äº›ç©ºé—´
                
                // åˆ›å»ºå†…å­˜
                memory = new WebAssembly.Memory({ initial: initialPages });
                
                const importObject = {
                    js: { mem: memory }
                };
                
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('sort.wasm'),
                    importObject
                );
                
                wasmInstance = wasmModule.instance;
                
                // æ³¨æ„ï¼šWebAssembly æ¨¡å—åªå¯¼å…¥å†…å­˜ï¼Œä¸å¯¼å‡ºå†…å­˜
                // æ‰€ä»¥ç›´æ¥ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ memory å¯¹è±¡
                
                // ç¡®ä¿ memory å·²è®¾ç½®
                if (!memory) {
                    throw new Error('å†…å­˜åˆå§‹åŒ–å¤±è´¥');
                }
                
                return wasmInstance;
            } catch (error) {
                console.error('åŠ è½½ WebAssembly å¤±è´¥:', error);
                // é‡ç½®çŠ¶æ€ï¼Œä»¥ä¾¿é‡è¯•
                wasmInstance = null;
                memory = null;
                throw error;
            }
        }
        
        // WebAssembly æ’åº
        async function wasmSort(data, algorithm) {
            // ç¡®ä¿ WebAssembly å·²åˆå§‹åŒ–
            await initWasm();
            
            // åŒé‡æ£€æŸ¥ memory å’Œ wasmInstance
            if (!memory) {
                throw new Error('WebAssembly å†…å­˜æœªåˆå§‹åŒ–');
            }
            
            if (!wasmInstance) {
                throw new Error('WebAssembly å®ä¾‹æœªåˆå§‹åŒ–');
            }
            
            const length = data.length;
            const bytesNeeded = length * 4; // æ¯ä¸ª i32 å  4 å­—èŠ‚
            
            // æ£€æŸ¥å†…å­˜æ˜¯å¦è¶³å¤Ÿ
            try {
                // å†æ¬¡ç¡®è®¤ memory å­˜åœ¨ä¸”æœ‰ buffer å±æ€§
                if (!memory || !memory.buffer) {
                    throw new Error('å†…å­˜å¯¹è±¡æ— æ•ˆ');
                }
                
                const currentSize = memory.buffer.byteLength;
                if (bytesNeeded > currentSize) {
                    const pagesToGrow = Math.ceil((bytesNeeded - currentSize) / (64 * 1024)) + 1;
                    memory.grow(pagesToGrow);
                }
            } catch (error) {
                console.error('å†…å­˜æ“ä½œå¤±è´¥:', error);
                console.error('memory çŠ¶æ€:', { memory, wasmInstance });
                throw new Error(`å†…å­˜æ“ä½œå¤±è´¥: ${error.message}`);
            }
            
            // å°†æ•°æ®å¤åˆ¶åˆ° WebAssembly å†…å­˜
            if (!memory || !memory.buffer) {
                throw new Error('å†…å­˜å¯¹è±¡æ— æ•ˆï¼Œæ— æ³•å¤åˆ¶æ•°æ®');
            }
            
            const view = new Int32Array(memory.buffer);
            view.set(data, 0);
            
            // è°ƒç”¨æ’åºå‡½æ•°
            try {
                if (algorithm === 'quicksort') {
                    wasmInstance.exports.quicksort(0, length);
                } else {
                    wasmInstance.exports.bubblesort(0, length);
                }
            } catch (error) {
                console.error('æ’åºå‡½æ•°è°ƒç”¨å¤±è´¥:', error);
                throw new Error(`æ’åºå¤±è´¥: ${error.message}`);
            }
            
            // ä» WebAssembly å†…å­˜è¯»å–æ’åºåçš„æ•°æ®
            if (!memory || !memory.buffer) {
                throw new Error('å†…å­˜å¯¹è±¡æ— æ•ˆï¼Œæ— æ³•è¯»å–æ•°æ®');
            }
            
            const sortedData = new Int32Array(memory.buffer, 0, length);
            return sortedData.slice();
        }
        
        // è¿è¡Œæ’åºæµ‹è¯•
        async function runSortingTest() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const comparisonDiv = document.getElementById('comparison');
            const btnTest = document.getElementById('btnTest');
            const dataSizeInput = document.getElementById('dataSize');
            const algorithmSelect = document.getElementById('algorithm');
            
            const dataSize = parseInt(dataSizeInput.value);
            const algorithm = algorithmSelect.value;
            
            if (dataSize < 1000) {
                alert('æ•°æ®é‡è‡³å°‘ä¸º 1000ï¼');
                return;
            }
            
            btnTest.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'status loading';
            statusDiv.textContent = `æ­£åœ¨ç”Ÿæˆ ${dataSize.toLocaleString()} ä¸ªéšæœºæ•°...`;
            
            try {
                // ç”Ÿæˆæµ‹è¯•æ•°æ®
                const testData = generateTestData(dataSize);
                const testDataCopy1 = new Int32Array(testData);
                const testDataCopy2 = new Int32Array(testData);
                
                // æµ‹è¯• JavaScript æ€§èƒ½
                statusDiv.textContent = 'æµ‹è¯• JavaScript æ€§èƒ½...';
                const jsStart = performance.now();
                let jsSorted;
                
                if (algorithm === 'quicksort') {
                    jsSorted = jsQuicksort(Array.from(testDataCopy1));
                } else {
                    jsSorted = jsNativeSort(Array.from(testDataCopy1));
                }
                
                const jsEnd = performance.now();
                const jsTime = jsEnd - jsStart;
                const jsSpeed = dataSize / (jsTime / 1000);
                
                // éªŒè¯æ’åºç»“æœ
                const jsIsSorted = isSorted(jsSorted);
                
                // æµ‹è¯• WebAssembly æ€§èƒ½
                statusDiv.textContent = 'æµ‹è¯• WebAssembly æ€§èƒ½...';
                const wasmStart = performance.now();
                let wasmSorted;
                try {
                    wasmSorted = await wasmSort(testDataCopy2, algorithm);
                } catch (error) {
                    console.error('WebAssembly æ’åºå¤±è´¥:', error);
                    throw new Error(`WebAssembly æ’åºå¤±è´¥: ${error.message}`);
                }
                const wasmEnd = performance.now();
                const wasmTime = wasmEnd - wasmStart;
                const wasmSpeed = dataSize / (wasmTime / 1000);
                
                // éªŒè¯æ’åºç»“æœ
                const wasmIsSorted = isSorted(wasmSorted);
                
                // æ˜¾ç¤ºç»“æœ
                statusDiv.className = 'status success';
                statusDiv.textContent = 'âœ… æµ‹è¯•å®Œæˆï¼';
                
                resultsDiv.innerHTML = `
                    <div class="result-box js">
                        <h3>JavaScript ç»“æœ</h3>
                        <div class="metric">
                            <strong>æ‰§è¡Œæ—¶é—´:</strong>
                            <span class="metric-value">${jsTime.toFixed(2)} ms</span>
                        </div>
                        <div class="metric">
                            <strong>æ’åºé€Ÿåº¦:</strong>
                            <span class="metric-value">${(jsSpeed / 1000).toFixed(2)} Kå…ƒç´ /ç§’</span>
                        </div>
                        <div class="metric">
                            <strong>æ•°æ®é‡:</strong>
                            <span class="metric-value">${dataSize.toLocaleString()}</span>
                        </div>
                        <div class="metric">
                            <strong>æ’åºæ­£ç¡®:</strong>
                            <span class="metric-value">${jsIsSorted ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                        </div>
                    </div>
                    <div class="result-box wasm">
                        <h3>WebAssembly ç»“æœ</h3>
                        <div class="metric">
                            <strong>æ‰§è¡Œæ—¶é—´:</strong>
                            <span class="metric-value">${wasmTime.toFixed(2)} ms</span>
                        </div>
                        <div class="metric">
                            <strong>æ’åºé€Ÿåº¦:</strong>
                            <span class="metric-value">${(wasmSpeed / 1000).toFixed(2)} Kå…ƒç´ /ç§’</span>
                        </div>
                        <div class="metric">
                            <strong>æ•°æ®é‡:</strong>
                            <span class="metric-value">${dataSize.toLocaleString()}</span>
                        </div>
                        <div class="metric">
                            <strong>æ’åºæ­£ç¡®:</strong>
                            <span class="metric-value">${wasmIsSorted ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                        </div>
                    </div>
                `;
                
                // æ€§èƒ½å¯¹æ¯”
                const speedup = jsTime / wasmTime;
                comparisonDiv.style.display = 'block';
                document.getElementById('speedup').innerHTML = `
                    WebAssembly æ¯” JavaScript <span style="color: #d63384;">å¿« ${speedup.toFixed(2)}x</span>
                `;
                
            } catch (error) {
                statusDiv.className = 'status error';
                let errorMessage = `âŒ é”™è¯¯: ${error.message}`;
                
                // æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                if (error.message.includes('å†…å­˜') || error.message.includes('buffer')) {
                    errorMessage += '\n\nå¯èƒ½çš„åŸå› ï¼š\n';
                    errorMessage += '1. WebAssembly æ¨¡å—åŠ è½½å¤±è´¥\n';
                    errorMessage += '2. å†…å­˜åˆå§‹åŒ–å¤±è´¥\n';
                    errorMessage += '3. è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯';
                }
                
                statusDiv.textContent = errorMessage;
                console.error('æµ‹è¯•å¤±è´¥:', error);
                console.error('å½“å‰çŠ¶æ€:', { 
                    wasmInstance: !!wasmInstance, 
                    memory: !!memory,
                    memoryBuffer: memory ? !!memory.buffer : false
                });
            } finally {
                btnTest.disabled = false;
            }
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('comparison').style.display = 'none';
            document.getElementById('status').style.display = 'none';
        }
    </script>
</body>
</html>

