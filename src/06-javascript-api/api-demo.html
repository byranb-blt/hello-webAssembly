<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript API ç¤ºä¾‹ - WebAssembly</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            border-bottom: 3px solid #007acc;
            padding-bottom: 10px;
            font-size: 28px;
            font-weight: bold;
        }
        h2 {
            color: #2a2a2a;
            font-size: 20px;
            font-weight: 600;
            margin-top: 0;
        }
        p {
            color: #333;
            font-size: 16px;
            margin: 10px 0;
        }
        .demo-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .demo-section p {
            color: #444;
            font-size: 15px;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #e8f4f8;
            border-left: 4px solid #007acc;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            color: #1a1a1a;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
        }
        code {
            background: #f4f4f4;
            padding: 3px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #c7254e;
            font-size: 14px;
            font-weight: 500;
        }
        .api-list {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }
        .api-list strong {
            color: #664d03;
            font-size: 16px;
        }
        .api-list ul {
            color: #856404;
            font-size: 15px;
            margin: 10px 0;
            padding-left: 20px;
        }
        .api-list li {
            margin: 5px 0;
        }
        .api-list code {
            color: #856404;
            background: #fff8e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ WebAssembly JavaScript API ç¤ºä¾‹</h1>
        <p>æ¼”ç¤º WebAssembly JavaScript API çš„å„ç§ç”¨æ³•</p>
        
        <div class="api-list">
            <strong>ä¸»è¦ APIï¼š</strong>
            <ul>
                <li><code>WebAssembly.instantiateStreaming()</code> - æµå¼åŠ è½½å’Œå®ä¾‹åŒ–</li>
                <li><code>WebAssembly.instantiate()</code> - åŠ è½½å’Œå®ä¾‹åŒ–</li>
                <li><code>WebAssembly.compile()</code> - ç¼–è¯‘æ¨¡å—</li>
                <li><code>WebAssembly.validate()</code> - éªŒè¯äºŒè¿›åˆ¶ä»£ç </li>
                <li><code>WebAssembly.Memory()</code> - åˆ›å»ºå†…å­˜</li>
                <li><code>WebAssembly.Table()</code> - åˆ›å»ºè¡¨</li>
                <li><code>WebAssembly.Global()</code> - åˆ›å»ºå…¨å±€å˜é‡</li>
            </ul>
        </div>
        
        <div class="demo-section">
            <h2>1. æµå¼åŠ è½½ (instantiateStreaming)</h2>
            <p>æ¨èæ–¹å¼ï¼šç›´æ¥ä» Response æµåŠ è½½å’Œå®ä¾‹åŒ–</p>
            <button onclick="demoStreaming()">æ¼”ç¤ºæµå¼åŠ è½½</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>2. éæµå¼åŠ è½½ (instantiate)</h2>
            <p>å…ˆè·å– ArrayBufferï¼Œå†å®ä¾‹åŒ–</p>
            <button onclick="demoNonStreaming()">æ¼”ç¤ºéæµå¼åŠ è½½</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>3. ç¼–è¯‘å’Œå®ä¾‹åŒ–åˆ†ç¦»</h2>
            <p>å…ˆç¼–è¯‘æ¨¡å—ï¼Œå†å¤šæ¬¡å®ä¾‹åŒ–ï¼ˆé€‚åˆæ¨¡å—å¤ç”¨ï¼‰</p>
            <button onclick="demoCompileSeparate()">æ¼”ç¤ºåˆ†ç¦»ç¼–è¯‘</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>4. éªŒè¯äºŒè¿›åˆ¶ä»£ç </h2>
            <p>æ£€æŸ¥ WebAssembly äºŒè¿›åˆ¶ä»£ç æ˜¯å¦æœ‰æ•ˆ</p>
            <button onclick="demoValidate()">æ¼”ç¤ºéªŒè¯</button>
            <div id="result4" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>5. Memory æ“ä½œ</h2>
            <p>åˆ›å»ºã€è®¿é—®å’Œå¢é•¿å†…å­˜</p>
            <button onclick="demoMemory()">æ¼”ç¤ºå†…å­˜æ“ä½œ</button>
            <div id="result5" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>6. Table æ“ä½œ</h2>
            <p>åˆ›å»ºã€è®¿é—®å’Œä¿®æ”¹è¡¨ï¼ˆæ³¨æ„ï¼šTable åªèƒ½å­˜å‚¨ WebAssembly å‡½æ•°å¯¹è±¡ï¼Œä¸èƒ½å­˜å‚¨æ™®é€š JavaScript å‡½æ•°ï¼‰</p>
            <button onclick="demoTable()">æ¼”ç¤ºè¡¨æ“ä½œ</button>
            <div id="result6" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>7. Global æ“ä½œ</h2>
            <p>åˆ›å»ºå’Œæ“ä½œå…¨å±€å˜é‡</p>
            <button onclick="demoGlobal()">æ¼”ç¤ºå…¨å±€å˜é‡</button>
            <div id="result7" class="result" style="display:none;"></div>
        </div>
        
        <div class="demo-section">
            <h2>8. é”™è¯¯å¤„ç†</h2>
            <p>å¤„ç†ç¼–è¯‘ã€é“¾æ¥å’Œè¿è¡Œæ—¶é”™è¯¯</p>
            <button onclick="demoErrorHandling()">æ¼”ç¤ºé”™è¯¯å¤„ç†</button>
            <div id="result8" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        // 1. æµå¼åŠ è½½
        async function demoStreaming() {
            const resultDiv = document.getElementById('result1');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'åŠ è½½ä¸­...';
            
            try {
                // ä½¿ç”¨ç®€å•çš„ add.wasmï¼ˆéœ€è¦å…ˆç¼–è¯‘ï¼‰
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('../01-hello-world/add.wasm')
                );
                
                const result = wasmModule.instance.exports.add(10, 20);
                resultDiv.textContent = `âœ… æµå¼åŠ è½½æˆåŠŸï¼\nè°ƒç”¨ add(10, 20) = ${result}`;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}\n\næç¤ºï¼šç¡®ä¿ add.wasm æ–‡ä»¶å­˜åœ¨`;
            }
        }

        // 2. éæµå¼åŠ è½½
        async function demoNonStreaming() {
            const resultDiv = document.getElementById('result2');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch('../01-hello-world/add.wasm');
                const bytes = await response.arrayBuffer();
                
                const wasmModule = await WebAssembly.instantiate(bytes);
                
                const result = wasmModule.instance.exports.add(15, 25);
                resultDiv.textContent = `âœ… éæµå¼åŠ è½½æˆåŠŸï¼\nè°ƒç”¨ add(15, 25) = ${result}`;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }

        // 3. ç¼–è¯‘å’Œå®ä¾‹åŒ–åˆ†ç¦»
        async function demoCompileSeparate() {
            const resultDiv = document.getElementById('result3');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'ç¼–è¯‘ä¸­...';
            
            try {
                // ç¼–è¯‘æ¨¡å—
                const response = await fetch('../01-hello-world/add.wasm');
                const bytes = await response.arrayBuffer();
                const module = await WebAssembly.compile(bytes);
                
                resultDiv.textContent = 'âœ… æ¨¡å—ç¼–è¯‘æˆåŠŸï¼\n\n';
                
                // å¤šæ¬¡å®ä¾‹åŒ–
                const instance1 = new WebAssembly.Instance(module);
                const instance2 = new WebAssembly.Instance(module);
                
                const result1 = instance1.exports.add(5, 3);
                const result2 = instance2.exports.add(7, 8);
                
                resultDiv.textContent += `å®ä¾‹1: add(5, 3) = ${result1}\n`;
                resultDiv.textContent += `å®ä¾‹2: add(7, 8) = ${result2}\n\n`;
                resultDiv.textContent += 'âœ… åŒä¸€ä¸ªæ¨¡å—å¯ä»¥åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼';
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }

        // 4. éªŒè¯äºŒè¿›åˆ¶ä»£ç 
        async function demoValidate() {
            const resultDiv = document.getElementById('result4');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'éªŒè¯ä¸­...';
            
            try {
                // è·å–æœ‰æ•ˆçš„ wasm æ–‡ä»¶
                const response = await fetch('../01-hello-world/add.wasm');
                const validBytes = await response.arrayBuffer();
                
                // éªŒè¯æœ‰æ•ˆä»£ç 
                const isValid = WebAssembly.validate(validBytes);
                resultDiv.textContent = `âœ… æœ‰æ•ˆä»£ç éªŒè¯: ${isValid}\n\n`;
                
                // éªŒè¯æ— æ•ˆä»£ç 
                const invalidBytes = new Uint8Array([0x00, 0x01, 0x02, 0x03]);
                const isInvalid = WebAssembly.validate(invalidBytes);
                resultDiv.textContent += `âŒ æ— æ•ˆä»£ç éªŒè¯: ${isInvalid}`;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }

        // 5. Memory æ“ä½œ
        async function demoMemory() {
            const resultDiv = document.getElementById('result5');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'åˆ›å»ºå†…å­˜...';
            
            try {
                // åˆ›å»ºå†…å­˜
                const memory = new WebAssembly.Memory({ 
                    initial: 1,  // 1é¡µ = 64KB
                    maximum: 10  // æœ€å¤§10é¡µ
                });
                
                resultDiv.textContent = `âœ… å†…å­˜åˆ›å»ºæˆåŠŸï¼\n`;
                resultDiv.textContent += `åˆå§‹å¤§å°: ${memory.buffer.byteLength} å­—èŠ‚ (${memory.buffer.byteLength / 1024} KB)\n\n`;
                
                // å†™å…¥æ•°æ®
                const view = new Uint8Array(memory.buffer);
                const text = "Hello, Memory!";
                const encoder = new TextEncoder();
                const encoded = encoder.encode(text);
                view.set(encoded, 0);
                
                resultDiv.textContent += `å†™å…¥æ•°æ®: "${text}"\n\n`;
                
                // è¯»å–æ•°æ®
                const decoder = new TextDecoder();
                const decoded = decoder.decode(view.slice(0, text.length));
                resultDiv.textContent += `è¯»å–æ•°æ®: "${decoded}"\n\n`;
                
                // å¢é•¿å†…å­˜
                memory.grow(1);
                resultDiv.textContent += `âœ… å†…å­˜å¢é•¿åå¤§å°: ${memory.buffer.byteLength} å­—èŠ‚`;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }

        // 6. Table æ“ä½œ
        async function demoTable() {
            const resultDiv = document.getElementById('result6');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'åŠ è½½ WebAssembly æ¨¡å—...';
            
            try {
                // é¦–å…ˆåŠ è½½ä¸€ä¸ªåŒ…å«å‡½æ•°çš„ WebAssembly æ¨¡å—
                // Table åªèƒ½å­˜å‚¨ WebAssembly å‡½æ•°ï¼Œä¸èƒ½å­˜å‚¨æ™®é€š JavaScript å‡½æ•°
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('table-demo.wasm')
                );
                const wasmInstance = wasmModule.instance;
                
                resultDiv.textContent = `âœ… WebAssembly æ¨¡å—åŠ è½½æˆåŠŸï¼\n\n`;
                
                // åˆ›å»ºè¡¨
                const table = new WebAssembly.Table({ 
                    initial: 3, 
                    element: "anyfunc" 
                });
                
                resultDiv.textContent += `âœ… è¡¨åˆ›å»ºæˆåŠŸï¼\n`;
                resultDiv.textContent += `åˆå§‹å¤§å°: ${table.length}\n\n`;
                
                // è·å– WebAssembly å¯¼å‡ºçš„å‡½æ•°ï¼ˆè¿™äº›æ˜¯çœŸæ­£çš„ Wasm å‡½æ•°å¯¹è±¡ï¼‰
                const func1 = wasmInstance.exports.func1;
                const func2 = wasmInstance.exports.func2;
                const func3 = wasmInstance.exports.func3;
                
                // è®¾ç½®å‡½æ•°åˆ°è¡¨ä¸­ï¼ˆå¿…é¡»æ˜¯ WebAssembly å‡½æ•°å¯¹è±¡ï¼‰
                table.set(0, func1);
                table.set(1, func2);
                table.set(2, func3);
                
                resultDiv.textContent += `è®¾ç½® WebAssembly å‡½æ•°åˆ°è¡¨ä¸­...\n\n`;
                
                // è·å–å¹¶è°ƒç”¨å‡½æ•°
                const result1 = table.get(0)();
                const result2 = table.get(1)();
                const result3 = table.get(2)();
                
                resultDiv.textContent += `table.get(0)() = ${result1}\n`;
                resultDiv.textContent += `table.get(1)() = ${result2}\n`;
                resultDiv.textContent += `table.get(2)() = ${result3}\n\n`;
                
                // å¢é•¿è¡¨
                table.grow(1);
                resultDiv.textContent += `âœ… è¡¨å¢é•¿åå¤§å°: ${table.length}\n\n`;
                resultDiv.textContent += `æ³¨æ„ï¼šTable åªèƒ½å­˜å‚¨ WebAssembly å‡½æ•°å¯¹è±¡ï¼Œ\nä¸èƒ½å­˜å‚¨æ™®é€šçš„ JavaScript å‡½æ•°ã€‚`;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}\n\næç¤ºï¼šè¯·ç¡®ä¿ table-demo.wasm æ–‡ä»¶å­˜åœ¨`;
            }
        }

        // 7. Global æ“ä½œ
        async function demoGlobal() {
            const resultDiv = document.getElementById('result7');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'åˆ›å»ºå…¨å±€å˜é‡...';
            
            try {
                // åˆ›å»ºå¯å˜å…¨å±€å˜é‡
                const global = new WebAssembly.Global({ 
                    value: "i32", 
                    mutable: true 
                }, 0);
                
                resultDiv.textContent = `âœ… å…¨å±€å˜é‡åˆ›å»ºæˆåŠŸï¼\n`;
                resultDiv.textContent += `åˆå§‹å€¼: ${global.value}\n\n`;
                
                // ä¿®æ”¹å€¼
                global.value = 42;
                resultDiv.textContent += `è®¾ç½®å€¼: ${global.value}\n`;
                
                global.value = 100;
                resultDiv.textContent += `å†æ¬¡è®¾ç½®: ${global.value}\n\n`;
                
                // åˆ›å»ºä¸å¯å˜å…¨å±€å˜é‡
                const constGlobal = new WebAssembly.Global({ 
                    value: "i32", 
                    mutable: false 
                }, 999);
                
                resultDiv.textContent += `âœ… ä¸å¯å˜å…¨å±€å˜é‡åˆ›å»ºæˆåŠŸï¼\n`;
                resultDiv.textContent += `å€¼: ${constGlobal.value}\n`;
                resultDiv.textContent += `(å°è¯•ä¿®æ”¹ä¼šå¤±è´¥)`;
            } catch (error) {
                resultDiv.textContent = `âŒ é”™è¯¯: ${error.message}`;
            }
        }

        // 8. é”™è¯¯å¤„ç†
        async function demoErrorHandling() {
            const resultDiv = document.getElementById('result8');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æ¼”ç¤ºé”™è¯¯å¤„ç†...';
            
            let output = '';
            
            // 1. CompileError
            try {
                const invalidWasm = new Uint8Array([0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00, 0xFF]);
                await WebAssembly.compile(invalidWasm);
            } catch (error) {
                if (error instanceof WebAssembly.CompileError) {
                    output += `âœ… CompileError æ•è·æˆåŠŸ\n`;
                    output += `æ¶ˆæ¯: ${error.message}\n\n`;
                }
            }
            
            // 2. LinkError (å¯¼å…¥ç¼ºå¤±)
            try {
                const wasmBytes = await fetch('../01-hello-world/add.wasm').then(r => r.arrayBuffer());
                const module = await WebAssembly.compile(wasmBytes);
                // æ•…æ„æä¾›é”™è¯¯çš„å¯¼å…¥
                await new WebAssembly.Instance(module, { wrong: { import: () => {} } });
            } catch (error) {
                if (error instanceof WebAssembly.LinkError) {
                    output += `âœ… LinkError æ•è·æˆåŠŸ\n`;
                    output += `æ¶ˆæ¯: ${error.message}\n\n`;
                }
            }
            
            // 3. RuntimeError
            try {
                // åˆ›å»ºä¸€ä¸ªä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯çš„æ¨¡å—
                const wasmModule = await WebAssembly.instantiateStreaming(
                    fetch('../01-hello-world/add.wasm')
                );
                // æ­£å¸¸è°ƒç”¨ä¸ä¼šå‡ºé”™
                wasmModule.instance.exports.add(1, 2);
                output += `âœ… æ­£å¸¸æ‰§è¡ŒæˆåŠŸ\n`;
                output += `(RuntimeError é€šå¸¸å‘ç”Ÿåœ¨ WebAssembly ä»£ç å†…éƒ¨)\n\n`;
            } catch (error) {
                if (error instanceof WebAssembly.RuntimeError) {
                    output += `âœ… RuntimeError æ•è·æˆåŠŸ\n`;
                    output += `æ¶ˆæ¯: ${error.message}\n`;
                }
            }
            
            output += `\né”™è¯¯ç±»å‹æ€»ç»“:\n`;
            output += `- CompileError: ç¼–è¯‘æ—¶é”™è¯¯\n`;
            output += `- LinkError: é“¾æ¥æ—¶é”™è¯¯ï¼ˆå¯¼å…¥/å¯¼å‡ºä¸åŒ¹é…ï¼‰\n`;
            output += `- RuntimeError: è¿è¡Œæ—¶é”™è¯¯`;
            
            resultDiv.textContent = output;
        }
    </script>
</body>
</html>

